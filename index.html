<!DOCTYPE html>
<html>

<head>
  <title>(X) SS23 crowd-report</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="./data.js"></script>
 
  <!--
   <script src="./js/d3.min.js"></script>
  <script src="./js/leaflet.js"></script>
  <link rel="stylesheet" type="text/css" href="./js/leaflet.css" />


  -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body style=" width:90%;overflow:hidden">
  <div id ="maindiv" style="touch-action: manipulation;width:100%;height:100%;overflow:hidden; ">
   
  <div id="map_div" style="width:100%;height:500px;"></div>
  <hr>
  
  <table style="width:100%">
    <tr><td>reporting:</td>
      <td><input type="text" value="spotter-name" style="width:50%;" oninput="
        set_name=this.value;console.log('meldender geändert auf: '+set_name)
        if (allowed_users.includes(this.value)){
        d3.select('#lock').text('UNLOCKED!')}
       
        ">
      </td>
      <td ><span id="lock">LOCKED</span></td>
    </tr>
    <tr>
      <td>density:</td>
      <td> <input type="range" id="densInput" min="0" max="10" value =5  onchange="set_dens= parseInt(this.value);infotag.text('dens '+this.value);d3.select('#dens_p').text(set_dens)"></td>
    <td> <span id="dens_p"> 5</span></td>
    </tr>
 
     <!-- 
    <tr>
  
  <td>tens:</td>
  <td>   <input type="range" id="tensInput" min="0" max="10" value =5  onchange="set_tens= parseInt(this.value);d3.select('#tens_p').text(set_tens)"></td>
  <td> <span id="tens_p"> 5</span></td>

    </tr>
-->
    <tr>
      <td>usage:</td>
      <td><input type="range" id="usageInput" min="0" max="150" step=10 value =50 onchange="set_usage= parseInt(this.value);d3.select('#usage_p').text(set_usage + ' %')">
      </td>
      <td>  <span id="usage_p"> 10%</span></td>
    </tr>

    <tr>
      <td>zone:</td>
      <td><select id="dropdown" name="dropdown" onchange="set_area = parseInt(this.value);console.log(this.value);select_area(this.value)">
  </select>
<button onclick=" mymap.on('click',function(e){ newarea.push([e.latlng.lat,e.latlng.lng]); console.log(newarea)})">new aera</button>
<button onclick=" mymap.on('click',function(e){ 
  L.marker([e.latlng.lat,e.latlng.lng],{icon:eventicon}).addTo(mymap);
 // mymap.on('click','console.log(12)')
infotag.text('icident reported at : '+[e.latlng.lat,e.latlng.lng])
})
  ">report incident  </button>

</td>
      <td><button onclick="writeReportToFirebase()">Send report</button></td>
    </tr>
  </table>
  

 

  <hr>
  <p id="infotag">Version 1.8 - loaded</p>

</div>
 
</body>

<script>
  newarea =[];
  allowed_users=["sandro","marc","test1","test2","test3"]
  existing_markers=[]
  isZooming = false
   infotag =    d3.select('#infotag')
  set_area=0
//set_pos= [24.99,46.51]
set_name ="falsereporter"
set_dens=0
set_tens = 0
set_usage=0
current ={
  "Big Beast Circle":{density:7,usage:7,tension:7},
  "Big Beast North":{density:7,usage:7,tension:7},
  "Big Beast South":{density:7,usage:7,tension:7},
  "Dance Tent":{density:7,usage:7,tension:7},
  "Down Beast":{density:7,usage:7,tension:7},
  "MDL Town":{density:7,usage:7,tension:7},
  "Underground 1":{density:7,usage:7,tension:7},
  "Underground 2":{density:7,usage:7,tension:7},
  "Underground 3":{density:7,usage:7,tension:7},
  "Underground 4":{density:7,usage:7,tension:7},
  }
farbskala = ["lightblue","#00B0F0","#00B0F0","#92D050","#92D050","#FFFF00","#FFFF00","#FF9201","#FF9201","#FF0000",'red',"#ee00ff","#ee00ff","#ee00ff","#ee00ff","#ee00ff"]
  
for(i=0;i<stages_list.length;i++){if(stages_list[i].coords != "donotdraw"){
    d3.select('#dropdown').append('option').attr('value',i).text(stages_list[i].name)
    }}

    start_everything()

    function start_everything(){
    initialise_map()
    initialise_firebase()
   
   // update_ownpos()


  setInterval(function() {
 update_ownpos()
 read_current()
  }, 5000);

  setTimeout(function () {
    update_ownpos()
    read_current()
  }, 3000);

// initialise_firebase()
    }

  

function update_ownpos(){
  
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                infotag.text( 'Geolocation is not supported by this browser.');
            }
        }

        function showPosition(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;

            infotag.text( 'Latitude: ' + latitude + '<br>Longitude: ' + longitude);
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    infotag.text( 'User denied the request for Geolocation.');
                    break;
                case error.POSITION_UNAVAILABLE:
                    infotag.text( 'Location information is unavailable.');
                    break;
                case error.TIMEOUT:
                    infotag.text( 'The request to get user location timed out.');
                    break;
                case error.UNKNOWN_ERROR:
                    infotag.text( 'An unknown error occurred.');
                    break;
            }
        }

      
  /*
  navigator.geolocation.watchPosition(
  (position) => {
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;
    // Handle the updated position here
    set_pos =[latitude,longitude]
    console.log("updateted becaus of change" +`Latitude: ${latitude}, Longitude: ${longitude}`);
  },
  (error) => {
    // Handle any errors that occur during geolocation
    console.error(`Error: ${error.message}`);
  }
);



  navigator.geolocation.getCurrentPosition(
            (position) => {
                // Extract latitude and longitude from the position object
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
               set_pos =[latitude,longitude]
             
              // das hier muss weg wenn wir vor ort sind, das ist der platzhalter wenn mann von woanders ausprobieren will

    //mymap.setView(set_pos)
//    ownmarker.setLatLng(set_pos )
              // Displnay the user's position information
             //  console.log(`Latitude: ${latitude}, Longitude: ${longitude}`)

             a = new Date()
   infotag.text('status: own loc upt at '+ set_pos +" " + a.getHours()+":"+a.getMinutes()+":"+a.getSeconds())
   a =a.getTime()
   const database = firebase.database()
     databaseRef = database.ref('soundstorm').child('locations').child(set_name);
    databaseRef.set({zeit:a,ort:set_pos})
       
            },
            (error) => {
                // Handle any errors that occur during geolocation
                console.log(`Error: ${error.message}`)
                infotag.text("no gps!!")
            }
         
        );

        
 
  
}
 */
function initialise_firebase(){
const firebaseConfig = {
        apiKey: "AIzaSyBOOdW1SHCwBZSchUJ7DfJZ1a7-dEYTvuQ",
        authDomain: "crowdcount-678c8.firebaseapp.com",
        databaseURL: "https://crowdcount-678c8-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "crowdcount-678c8",
        storageBucket: "crowdcount-678c8.appspot.com",
        messagingSenderId: "1020533758948",
        appId: "1:1020533758948:web:23ec6e175dff3b5eedc5f1",
        measurementId: "G-00674BETEZ"
        };
// Initialize Firebase
firebase.initializeApp(firebaseConfig);


      }  
function read_current (){

    database = firebase.database();
  
ref = database.ref('/soundstorm/aktuell');

ref.on('value', (snapshot) => {

  current = snapshot.val()
  


for(i=0;i<stages_list.length;i++){
   if(current[stages_list[i].name] != undefined){
    temp = current[stages_list[i].name]


   let  fcol = farbskala[Math.round(temp.usage/15)]
   let col = farbskala[Math.round(temp.density)]
    stages_list[i].geo.setStyle({
    //   opacity:1,
        fillOpacity:0.6,
        fillColor: fcol,
        color: col,
        "weight": 4
  })}
}

select_area(set_area)
});

ref = database.ref('/soundstorm/locations');

ref.on('value', (snapshot) => {

  locations = snapshot.val()



  Object.keys(locations).forEach((key) => {
    a = new Date()
      a =a.getTime()
      
      if(existing_markers.includes(key)) {
  eval(key+"_marker.setLatLng(locations[key].ort)")
}else{
  eval(key+"_marker = L.marker(locations[key].ort).bindPopup(key).addTo(eigensymbole_layer)")
    // hier die marker einmalen
  existing_markers.push(key)
}
    

})
})


ref = database.ref('/soundstorm/swipes');

ref.on('value', (snapshot) => {

  movement_layer.clearLayers();
  swipes_arr = snapshot.val()
  a = new Date()
      a =a.getTime()
      
  Object.keys(swipes_arr).forEach((key) => {
    x = (a -swipes_arr[key].zeit )
    
    if(x < 60000){
      var polyline = L.polyline([swipes_arr[key].von,swipes_arr[key].nach],{weight:swipes_arr[key].dicke,color:"red"}).addTo(movement_layer);
      var arrowHead = L.polylineDecorator(polyline, {    patterns: [      { offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({ pixelSize: 30, polygon: false, pathOptions: { fillOpacity: 1, weight:swipes_arr[key].dicke,color:"red" } }) }    ]}).addTo(movement_layer);
    
    }
  })

})


  }
function select_area(set_area){
    ausgew_area = stages_list[set_area].name
          d3.select('#densInput').attr('value',current[ausgew_area].density)
          d3.select('#dens_p').text(current[ausgew_area].density)
          d3.select('#usageInput').attr('value',current[ausgew_area].usage)
          d3.select('#usage_p').text(current[ausgew_area].usage+" %")

          set_dens = current[ausgew_area].density
          set_usage = current[ausgew_area].usage
          //dens_slider.node().dispatchEvent(new Event('input'));

  }
function initialise_map(){

  // Karte und Hintergründe
  mymap = L.map('map_div',{zoomSnap: 0.1, dragging: false,minzoom:10}).setView([24.997496213866462,46.51234272528364],15 )
   // mymap.on('zoomend', function() {setviewzoom = mymap.getZoom()});
   // mymap.on('moveend', function() { mapaa = (mymap.getCenter(),mymap.getCenter());setviewmap=[mapaa.lat,mapaa.lng]});

tl1= L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{      
      opacity: 0.5,      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    }).addTo(mymap);

var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    })

var Jawg_Matrix =  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
	subdomains: 'abcd',
	maxZoom: 20
});


// icons

eventicon = L.icon({
    iconUrl: './icons/red.png',
    iconSize:     [40, 40],
    iconAnchor:   [20, 40]
  })
//const imageUrl = './map1.png';
//const imageBounds = [ [25.013,46.4805],[24.988092848232725, 46.53216767460525]];
imageUrl ="./himapcut.jpg"
imageBounds = [[ 25.01322659611521, 46.4798932072461],[24.984476969706886,46.52926520707613]];


const imageOverlay = L.imageOverlay(imageUrl, imageBounds);

stages_layer = L.layerGroup().addTo(mymap)
green_layer = L.layerGroup().addTo(mymap)
eigensymbole_layer = L.layerGroup().addTo(mymap)
movement_layer = L.layerGroup().addTo(mymap)
parkinglot_layer = L.layerGroup().addTo(mymap)
zones_layer = L.layerGroup()
back_layer = L.layerGroup().addTo(mymap)
// alles einmalen das keine Bühnen sind
for (f=0;f<parking_arr.length;f++)  {
  let l = eval(parking_arr[f].layer)
  polygon = L.polygon(parking_arr[f].coords, {color: parking_arr[f].color}).addTo(l)

var tooltip = L.tooltip({permanent: true, direction: 'center'})
    .setContent(parking_arr[f].name)
    .setLatLng(polygon.getBounds().getCenter())
    .addTo(l);

}

for (f=0;f<greening_arr.length;f++) {L.polygon(greening_arr[f], {color: 'green'}).addTo(green_layer)}
for (f=0;f<blocking_arr.length;f++) {L.polygon(blocking_arr[f], {color: 'grey'}).addTo(green_layer)}
for (f=0;f<hinter.length;f++)       {L.polygon(hinter[f], {color: 'grey'}).addTo(back_layer)}
for (f=0;f<vib_arr.length;f++)      {L.polygon(vib_arr[f], {color: 'gold'}).addTo(mymap)}
for (f=0;f<walkway_arr.length;f++)      {L.polygon(walkway_arr[f], {color: 'grey'}).addTo(mymap)}
//for (f=0;f<walking_arr.length;f++)  {L.polygon(walking_arr[f], {color: 'red'}).addTo(green_layer)}

// Layercontroll
L.control.layers(
  {"OSM": tl1,"img": imageOverlay,"dark":Jawg_Matrix ,"sat":Esri_WorldImagery},
  {"stages":stages_layer,"blocks":green_layer,"spotter":eigensymbole_layer,"movement" :movement_layer,"parking lots":parkinglot_layer,"op-zones":zones_layer}).addTo(mymap);

//ownmarker = L.marker(  [24.996,46.508]).addTo(mymap);

// Swipefunktion
    let touchStartX, touchEndX;

mymap.getContainer().addEventListener("touchstart", function (e) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    start_time = new Date()
});

mymap.on('zoomlevelschange', function () {
    // This event is triggered when the zoom level changes (e.g., button press)
    // You can handle button press logic here
    isZooming = true;
    setTimeout(function () {
isZooming = false
  }, 500);
});

mymap.on('zoomstart', function() {
    isZooming = true;
});

mymap.on('zoomend', function() {
    isZooming = false;
});


// hier werden die swipes aufgenommen und gespeichert in der firebase  
mymap.getContainer().addEventListener("touchend", function (e) {
  if(!isZooming){
    touchEndX = e.changedTouches[0].clientX;
    touchEndY = e.changedTouches[0].clientY;
    ort1 = mymap.containerPointToLatLng([touchStartX,touchStartY]);
    ort2 = mymap.containerPointToLatLng([touchEndX,touchEndY]);

    minmove = 0.001
    maxmove = 0.01
    move = Math.abs(ort1.lat - ort2.lat) + Math.abs(ort1.lng - ort2.lng)
    
   if(move> minmove && move <maxmove)
   { end_date = new Date()   
    diff = (end_date.getTime()-start_time.getTime())/1000
    www = 10*(0.5+diff)
      
  //malen des Swipes und des Pfeilkopfes
      var polyline = L.polyline([ort1,ort2],{weight:www}).addTo(mymap);
      var arrowHead = L.polylineDecorator(polyline, {    patterns: [      { offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({ pixelSize: 30, polygon: false, pathOptions: { fillOpacity: 1, weight:www } }) }    ]}).addTo(mymap);
      infotag.text("swipe gespeichert!"+ diff)

  // timeer der eingegebene Swipes vernichtet
  setTimeout(function () {
    mymap.removeLayer(polyline);
    mymap.removeLayer(arrowHead);
  }, 5000);

    ntemp = new Date()
    ntemp = ntemp.getTime()

    // !!!! hier sit das speichern des swipes deaktiviert !!!!!!!!!!!!
     const database = firebase.database()
     databaseRef = database.ref('soundstorm').child('swipes').child(ntemp);
    databaseRef.set({meldender:set_name,von:ort1, nach:ort2,zeit:ntemp,dicke:www})
    }
  }})

// Bühnen einmalen
stages_geo=[]
for(i=0;i<stages_list.length;i++)
{if(stages_list[i].coords != "donotdraw"){
  let zi =i 
  f = L.polygon(stages_list[i].coords, {color: '#99ff66'}).bindPopup(stages_list[i].name)
      //.on('mouseover',function(){this.setStyle({color:"red"})})
      .on('click',function(){
      // this.setStyle({color:"green"})
      set_area=zi;d3.select('#dropdown').property('value',zi)
      select_area(zi)
      
  }).addTo(stages_layer)
  stages_list[i].geo = f
}}}

function writeReportToFirebase() {
      jetzt = new Date()
   
      const database = firebase.database();
      // Replace 'your-data' with the path where you want to write the data in the database
      // For example, if you want to write data to 'https://your-project-id.firebaseio.com/users', use 'users'
       databaseRef = database.ref('soundstorm').child('SS23').child(jetzt.getTime());
      // Data you want to write to the database

      const dataToWrite = {
        zeit: jetzt.getTime(),
        name: set_name,
        area: set_area,
        density: set_dens,
        position: set_pos,
        tension: set_tens,
        usage: set_usage,
      };

     // Push the data to the database
      databaseRef.set(dataToWrite)
        .then(() => {
          console.log("Data was successfully written to the Firebase database.");
        })
        .catch((error) => {
          console.error("Error writing data to the Firebase database:", error);
          infotag.text("no connection!!")
        });

        d3.select('#infotag').text('status: report sent at '+ jetzt.getHours()+":"+jetzt.getMinutes()+":"+jetzt.getSeconds())

        // hier wird versucht zusätzlich einen report über die aktuelle alge zusammenzustellen

       
        databaseRef = database.ref('soundstorm').child('aktuell').child(stages_list[set_area].name);
        databaseRef.set({zeit:jetzt.getTime(), density: set_dens, tension: set_tens,  usage: set_usage})

        read_current()
    }

    
function zeige_farbskala(){
md =d3.select('#maindiv')

for (i=0;i<farbskala.length;i++){
  md.append('p').style('background-color',farbskala[i]).text("density:" + i + " / usage: " + i * 10 + " %")

}}

//ab 100 rot
  </script>

</html>
